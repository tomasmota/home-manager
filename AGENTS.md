# AGENTS.md

## Purpose
- This repo manages Tom√°s' local developer environment with Nix, using Home Manager on Linux and nix-darwin + Home Manager on macOS.
- Treat this repo as the source of truth for shell, terminal, editor, git, tmux, and AI-agent config.

## Host Targets
- macOS target: `darwinConfigurations.macbook` (`aarch64-darwin`, home `/Users/tomas`).
- Linux target: `homeConfigurations.linux` (`x86_64-linux`, home `/home/tomas`).
- Username is hardcoded as `tomas` in `flake.nix`.

## Repo Map
- `flake.nix`, `flake.lock`: flake entrypoint and pinned inputs (`nixpkgs`, `home-manager`, `nix-darwin`).
- `home.nix`: shared Home Manager module; imports most local modules and declares common packages.
- `darwin/macos.nix`: macOS-only nix-darwin config (system defaults, Homebrew casks, Tailscale).
- `terminal/ghostty.nix`: Ghostty config; expects `fontSize` from flake `extraSpecialArgs`.
- `shell/zsh.nix`, `shell/aliases.nix`, `shell/functions.nix`: shell behavior, aliases, helper functions.
- `git.nix`: git identity/signing, difftastic, activation hook for `allowed_signers` files.
- `tmux.nix`: tmux settings/plugins/keybindings.
- `nvim/`: Neovim config (lazy.nvim, plugin specs under `nvim/lua/plugins`, core config under `nvim/lua/config`).
- `agents.nix`, `agents/**`: AI tool configs/policies (Gemini + OpenCode).
- `agents/skills/**`: shared cross-agent skills; each skill lives in `agents/skills/<skill-name>/SKILL.md`.
- `secrets.env`: local secrets file at repo root, intentionally gitignored.

## Configuration Composition Notes
- `home.nix` imports:
  - `./agents.nix`
  - `./terminal/ghostty.nix`
  - `./shell/zsh.nix`
  - `./git.nix`
  - `./tmux.nix`
- `home.nix` uses out-of-store symlinks for `nvim` and `agents` directories.
  - Editing files in this repo updates live config targets directly after switch.
- `agents.nix` symlinks repo files into:
  - `~/.gemini/settings.json`
  - `~/.gemini/policies`
  - `~/.config/opencode/opencode.json`

## Apply and Validate Workflows
- Preferred validation before applying:
  - `nix flake show`
  - `nix flake check`
- Linux:
  - Build only: `home-manager build --flake .#linux`
  - Apply: `home-manager switch --flake .#linux`
- macOS:
  - Build only: `darwin-rebuild build --flake .#macbook`
  - Apply: `sudo darwin-rebuild switch --flake .#macbook`
- Update dependencies:
  - `nix flake update` (then commit `flake.lock` changes)

## Editing Conventions
- Nix:
  - Keep existing style (2-space indentation, semicolon-terminated attrs, small focused modules).
  - Prefer editing the specific module rather than growing `home.nix`.
  - Do not hand-edit `flake.lock`; update it via `nix flake update`.
- Lua/Neovim:
  - Keep plugin config in `nvim/lua/plugins/*.lua` and base options/keymaps/autocmds in `nvim/lua/config/*`.
  - `nvim/lazy-lock.json` is generated by lazy.nvim; only change intentionally when updating plugins.
- Shell:
  - Keep aliases/functions concise and compatible with zsh.
  - `secrets.env` may be sourced by zsh init; never commit credentials.
- Agent policies:
  - Edit policy source files in `agents/gemini/policies/*.toml` and `agents/opencode/opencode.json`.
- Agent skills:
  - Add new skills under `agents/skills/<skill-name>/SKILL.md`.
  - Keep the existing frontmatter style (`name`, `description`, and `metadata`) and include usage-oriented sections.

## Safety and Gotchas
- `git.nix` writes `allowed_signers` files during activation; keep this behavior in mind when changing git/signing config.

## Commit Hygiene
- Keep commit messages short, imperative, and lowercase (matches current history style).
- Never commit `secrets.env` or other credential-bearing local files.
